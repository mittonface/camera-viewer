<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camera Viewer - Video Browser</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      h1 {
        color: #333;
      }
      .navigation {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .nav-section {
        flex: 1;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .nav-section h3 {
        margin-top: 0;
        color: #555;
      }
      .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 200px;
        overflow-y: auto;
      }
      .nav-list li {
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .nav-list li:hover {
        background-color: #e0e0e0;
      }
      .nav-list li.selected {
        background-color: #007bff;
        color: white;
      }
      .file-list {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .file-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .file-item:last-child {
        border-bottom: none;
      }
      .file-name {
        font-weight: bold;
      }
      .file-info {
        color: #666;
        font-size: 0.9em;
      }
      .storage-class {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: bold;
        margin-left: 10px;
      }
      .storage-standard {
        background-color: #d4edda;
        color: #155724;
      }
      .storage-glacier {
        background-color: #cce5ff;
        color: #004085;
      }
      .storage-deep-archive {
        background-color: #e7e8ea;
        color: #383d41;
      }
      .file-header {
        display: flex;
        align-items: center;
      }
      .clickable {
        cursor: pointer;
      }
      .clickable:hover {
        text-decoration: underline;
      }
      .video-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 1000;
      }
      .video-container {
        position: relative;
        width: 90%;
        max-width: 1200px;
        margin: 50px auto;
        text-align: center;
      }
      .close-button {
        position: absolute;
        top: 10px;
        right: 20px;
        color: white;
        font-size: 30px;
        cursor: pointer;
        z-index: 1001;
      }
      .close-button:hover {
        color: #ccc;
      }
      video {
        width: 100%;
        max-height: 80vh;
      }
      .video-title {
        color: white;
        margin-bottom: 20px;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
      .error {
        color: #d9534f;
        padding: 10px;
        background-color: #f2dede;
        border-radius: 4px;
        margin: 10px 0;
      }
      #selectedDate {
        font-size: 1.2em;
        margin-bottom: 15px;
        color: #333;
      }
      .latest-video-section {
        margin-bottom: 30px;
      }
      .latest-video-section h2 {
        color: #333;
        margin-bottom: 15px;
      }
      .no-video {
        color: #666;
        font-style: italic;
      }
      .refresh-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }
      .refresh-button:hover {
        background-color: #0056b3;
      }
      .latest-video-player {
        margin-top: 15px;
        text-align: center;
      }
      .latest-video-player video {
        width: 100%;
        max-width: 800px;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .video-unavailable {
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        text-align: center;
        color: #666;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="navigation">
      <div class="nav-section">
        <h3>Year</h3>
        <ul id="yearList" class="nav-list">
          <li class="loading">Loading years...</li>
        </ul>
      </div>
      <div class="nav-section">
        <h3>Month</h3>
        <ul id="monthList" class="nav-list">
          <li class="loading">Select a year first</li>
        </ul>
      </div>
      <div class="nav-section">
        <h3>Day</h3>
        <ul id="dayList" class="nav-list">
          <li class="loading">Select a month first</li>
        </ul>
      </div>
    </div>

    <div class="file-list">
      <h2>Video Files</h2>
      <div id="selectedDate"></div>
      <div id="fileList">
        <p class="loading">Select a date to view video files</p>
      </div>
    </div>
    <div class="latest-video-section">
      <h2>Latest Video (Today)</h2>
      <div id="latestVideoContainer" class="file-list">
        <p class="loading">Loading latest video...</p>
      </div>
    </div>
    <script>
      let selectedYear = null;
      let selectedMonth = null;
      let selectedDay = null;

      async function fetchData(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error("Error fetching data:", error);
          throw error;
        }
      }

      async function loadYears() {
        try {
          const data = await fetchData("/list-years");
          const yearList = document.getElementById("yearList");
          yearList.innerHTML = "";

          if (data.years && data.years.length > 0) {
            data.years.sort().forEach((year) => {
              const li = document.createElement("li");
              li.textContent = year;
              li.onclick = () => selectYear(year);
              yearList.appendChild(li);
            });
          } else {
            yearList.innerHTML = '<li class="loading">No years found</li>';
          }
        } catch (error) {
          document.getElementById("yearList").innerHTML =
            '<li class="error">Error loading years</li>';
        }
      }

      async function selectYear(year) {
        selectedYear = year;
        selectedMonth = null;
        selectedDay = null;

        // Update UI
        document.querySelectorAll("#yearList li").forEach((li) => {
          li.classList.toggle("selected", li.textContent === year);
        });

        // Reset month and day lists
        document.getElementById("monthList").innerHTML =
          '<li class="loading">Loading months...</li>';
        document.getElementById("dayList").innerHTML =
          '<li class="loading">Select a month first</li>';
        document.getElementById("fileList").innerHTML =
          '<p class="loading">Select a date to view video files</p>';
        document.getElementById("selectedDate").textContent = "";

        // Load months for selected year
        try {
          const data = await fetchData(`/list-months?year=${year}`);
          const monthList = document.getElementById("monthList");
          monthList.innerHTML = "";

          if (data.months && data.months.length > 0) {
            data.months.sort().forEach((month) => {
              const li = document.createElement("li");
              li.textContent = month;
              li.onclick = () => selectMonth(month);
              monthList.appendChild(li);
            });
          } else {
            monthList.innerHTML = '<li class="loading">No months found</li>';
          }
        } catch (error) {
          document.getElementById("monthList").innerHTML =
            '<li class="error">Error loading months</li>';
        }
      }

      async function selectMonth(month) {
        selectedMonth = month;
        selectedDay = null;

        // Update UI
        document.querySelectorAll("#monthList li").forEach((li) => {
          li.classList.toggle("selected", li.textContent === month);
        });

        // Reset day list
        document.getElementById("dayList").innerHTML =
          '<li class="loading">Loading days...</li>';
        document.getElementById("fileList").innerHTML =
          '<p class="loading">Select a date to view video files</p>';
        document.getElementById("selectedDate").textContent = "";

        // Load days for selected year/month
        try {
          const data = await fetchData(
            `/list-days?year=${selectedYear}&month=${selectedMonth}`
          );
          const dayList = document.getElementById("dayList");
          dayList.innerHTML = "";

          if (data.days && data.days.length > 0) {
            data.days.sort().forEach((day) => {
              const li = document.createElement("li");
              li.textContent = day;
              li.onclick = () => selectDay(day);
              dayList.appendChild(li);
            });
          } else {
            dayList.innerHTML = '<li class="loading">No days found</li>';
          }
        } catch (error) {
          document.getElementById("dayList").innerHTML =
            '<li class="error">Error loading days</li>';
        }
      }

      async function selectDay(day) {
        selectedDay = day;

        // Update UI
        document.querySelectorAll("#dayList li").forEach((li) => {
          li.classList.toggle("selected", li.textContent === day);
        });

        // Update selected date display
        document.getElementById(
          "selectedDate"
        ).textContent = `${selectedYear}-${selectedMonth}-${selectedDay}`;

        // Load files for selected date
        document.getElementById("fileList").innerHTML =
          '<p class="loading">Loading video files...</p>';

        try {
          const data = await fetchData(
            `/list-files-by-date?year=${selectedYear}&month=${selectedMonth}&day=${selectedDay}`
          );
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = "";

          if (data.files && data.files.length > 0) {
            data.files.forEach((file) => {
              const div = document.createElement("div");
              div.className = "file-item";

              const fileInfo = document.createElement("div");

              const fileHeader = document.createElement("div");
              fileHeader.className = "file-header";

              const fileName = document.createElement("div");
              fileName.className = "file-name";
              fileName.textContent = file.filename;

              // Make standard storage videos clickable
              if (file.storageClass === "STANDARD") {
                fileName.className += " clickable";
                fileName.style.color = "#007bff";
                fileName.onclick = () => playVideo(file.key, file.filename);
              }

              // Add storage class badge
              const storageClass = document.createElement("span");
              storageClass.className = "storage-class";

              switch (file.storageClass) {
                case "STANDARD":
                  storageClass.className += " storage-standard";
                  storageClass.textContent = "Standard";
                  break;
                case "GLACIER":
                  storageClass.className += " storage-glacier";
                  storageClass.textContent = "Glacier";
                  break;
                case "DEEP_ARCHIVE":
                  storageClass.className += " storage-deep-archive";
                  storageClass.textContent = "Glacier Deep Archive";
                  break;
                default:
                  storageClass.className += " storage-standard";
                  storageClass.textContent = file.storageClass || "Unknown";
              }

              fileHeader.appendChild(fileName);
              fileHeader.appendChild(storageClass);

              const fileDetails = document.createElement("div");
              fileDetails.className = "file-info";
              const fileSize = (file.size / (1024 * 1024)).toFixed(2);
              const lastModified = new Date(file.lastModified).toLocaleString();
              fileDetails.textContent = `${fileSize} MB - Modified: ${lastModified}`;

              fileInfo.appendChild(fileHeader);
              fileInfo.appendChild(fileDetails);
              div.appendChild(fileInfo);

              fileList.appendChild(div);
            });

            // Add count summary
            const summary = document.createElement("p");
            summary.style.marginTop = "15px";
            summary.style.color = "#666";
            summary.textContent = `Total: ${data.count} video${
              data.count !== 1 ? "s" : ""
            }`;
            fileList.appendChild(summary);
          } else {
            fileList.innerHTML =
              '<p class="loading">No video files found for this date</p>';
          }
        } catch (error) {
          document.getElementById("fileList").innerHTML =
            '<p class="error">Error loading video files</p>';
        }
      }

      async function playVideo(key, filename) {
        try {
          // Get presigned URL
          const response = await fetch(
            `/get-video-url?key=${encodeURIComponent(key)}`
          );
          if (!response.ok) {
            throw new Error("Failed to get video URL");
          }
          const data = await response.json();

          // Create modal if it doesn't exist
          let modal = document.getElementById("videoModal");
          if (!modal) {
            modal = document.createElement("div");
            modal.id = "videoModal";
            modal.className = "video-modal";
            modal.innerHTML = `
                        <div class="close-button" onclick="closeVideo()">&times;</div>
                        <div class="video-container">
                            <h2 class="video-title" id="videoTitle"></h2>
                            <video id="videoPlayer" controls autoplay></video>
                        </div>
                    `;
            document.body.appendChild(modal);

            // Close on background click
            modal.onclick = (e) => {
              if (e.target === modal) {
                closeVideo();
              }
            };
          }

          // Set video source and title
          document.getElementById("videoTitle").textContent = filename;
          const video = document.getElementById("videoPlayer");
          video.src = data.url;

          // Show modal
          modal.style.display = "block";
        } catch (error) {
          alert("Error loading video: " + error.message);
        }
      }

      function closeVideo() {
        const modal = document.getElementById("videoModal");
        if (modal) {
          modal.style.display = "none";
          const video = document.getElementById("videoPlayer");
          video.pause();
          video.src = "";
        }
      }

      // Close video on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeVideo();
        }
      });

      async function loadLatestVideo() {
        try {
          const data = await fetchData("/latest-video");
          const container = document.getElementById("latestVideoContainer");
          container.innerHTML = "";

          if (data.found && data.latestVideo) {
            const video = data.latestVideo;

            const div = document.createElement("div");
            div.className = "file-item";

            const fileInfo = document.createElement("div");

            const fileHeader = document.createElement("div");
            fileHeader.className = "file-header";

            const fileName = document.createElement("div");
            fileName.className = "file-name";
            fileName.textContent = video.filename;

            // No need to make clickable since video is displayed directly

            // Add storage class badge
            const storageClass = document.createElement("span");
            storageClass.className = "storage-class";

            switch (video.storageClass) {
              case "STANDARD":
                storageClass.className += " storage-standard";
                storageClass.textContent = "Standard";
                break;
              case "GLACIER":
                storageClass.className += " storage-glacier";
                storageClass.textContent = "Glacier";
                break;
              case "DEEP_ARCHIVE":
                storageClass.className += " storage-deep-archive";
                storageClass.textContent = "Glacier Deep Archive";
                break;
              default:
                storageClass.className += " storage-standard";
                storageClass.textContent = video.storageClass || "Unknown";
            }

            fileHeader.appendChild(fileName);
            fileHeader.appendChild(storageClass);

            const fileDetails = document.createElement("div");
            fileDetails.className = "file-info";
            const fileSize = (video.size / (1024 * 1024)).toFixed(2);
            const lastModified = new Date(video.lastModified).toLocaleString();
            fileDetails.textContent = `${fileSize} MB - Modified: ${lastModified}`;

            fileInfo.appendChild(fileHeader);
            fileInfo.appendChild(fileDetails);
            div.appendChild(fileInfo);

            container.appendChild(div);

            // Add video player for STANDARD storage videos
            if (video.storageClass === "STANDARD") {
              const videoPlayerDiv = document.createElement("div");
              videoPlayerDiv.className = "latest-video-player";
              videoPlayerDiv.innerHTML =
                '<p class="loading">Loading video...</p>';
              container.appendChild(videoPlayerDiv);

              // Get presigned URL and display video
              fetchData(`/get-video-url?key=${encodeURIComponent(video.key)}`)
                .then((urlData) => {
                  videoPlayerDiv.innerHTML = `<video controls preload="metadata">
                                    <source src="${urlData.url}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>`;
                })
                .catch((error) => {
                  videoPlayerDiv.innerHTML =
                    '<p class="error">Error loading video player</p>';
                });
            } else {
              const unavailableDiv = document.createElement("div");
              unavailableDiv.className = "video-unavailable";
              unavailableDiv.innerHTML = `<p>Video not available for direct playback</p>
                                                    <p>Storage class: ${video.storageClass}</p>
                                                    <p>Videos in Glacier or Deep Archive storage need to be restored before viewing.</p>`;
              container.appendChild(unavailableDiv);
            }

            // Add date info
            const dateInfo = document.createElement("p");
            dateInfo.style.marginTop = "10px";
            dateInfo.style.color = "#666";
            dateInfo.innerHTML = `Date: ${data.date} <button class="refresh-button" onclick="loadLatestVideo()">Refresh</button>`;
            container.appendChild(dateInfo);
          } else {
            container.innerHTML = `<p class="no-video">No videos found for today (${data.date}) <button class="refresh-button" onclick="loadLatestVideo()">Refresh</button></p>`;
          }
        } catch (error) {
          document.getElementById("latestVideoContainer").innerHTML =
            '<p class="error">Error loading latest video</p>';
        }
      }

      // Auto-refresh latest video every 5 minutes
      setInterval(loadLatestVideo, 5 * 60 * 1000);

      // Load years and latest video on page load
      loadYears();
      loadLatestVideo();
    </script>
  </body>
</html>
